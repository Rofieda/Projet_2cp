<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lmcs Quest</title>
    <link rel="stylesheet" href="../styles/Recherche3.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="../styles/BARS.css">
    <script src="../javascript/BARS.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600
;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
</head>
<body>
    <h1>La recherche d'une encadrement</h1>
    <div class="part1">
        <div class="partie-recherche">
            <div class="search-bar">
                <form action="/search" method="get">
                    <div class="search-input">
                        <span><img class="recherche-icon" src="../images/search-normal.png" alt="search Icon" /></span>
                        <input class="rechercher" type="search" placeholder="Rechercher ici" name="search">
                    </div>
                </form>
            </div>
            <div class="div-filtre">
                <button class="button-filtrer" type="submit">
                    <img class="filtre-icon" src="../images/filtrer.png" alt="filtrer Icon" />
                    <p class="p-filtre">Filtrer</p>
                </button>
            </div>
        </div>
        <div class="partie-filtre">
            <div class="dropdown">
                <div class="filtre1">
                    <div class="textBox-with-icon">
                        <input type="text" class="textBox" id="yearInput1" placeholder="   Date début 20XX" maxlength="4">
                    </div>
                    <span id="errorMessage1"></span>
                </div>
            </div>
            <div class="dropdown">
                <div class="filtre2">
                    <div class="textBox-with-icon">
                        <input type="text" class="textBox" id="yearInput2" placeholder="   Date fin 20XX" maxlength="4">
                    </div>
                    <span id="errorMessage2"></span>
                </div>
            </div>
            <div class="dropdown">
                <div class="filtre3">
                    <div class="textBox-with-icon">
                        <input type="text" class="textBox" placeholder="   Type" readonly>
                        <img class="menu-icon" src="../images/Down2.png" alt="menu-icon Icon" />
                    </div>
                    <span id="errorMessage"></span>
                </div>
                <div class="option">
                    <div onclick="showType('  PFE')">PFE</div>
                    <div onclick="showType('  Master')">Master</div>
                    <div onclick="showType('  Doctorat')">Doctorat</div>
                    <div onclick="showType('  Autre')">Autre</div>
                </div>
            </div>
            <div class="dropdown">
                <div class="filtre4">
                    <div class="textBox-with-icon">
                        <input type="text" class="textBox" placeholder="   Mots clés" >
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p class="champ"> Titre d'encadrement &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date début &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;Date fin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <ul class="publication-list">
            <li>
                <span>Optimisation Multi-objectif des Systèmes Embarqués</span>
                <span>Master</span>
                <span>9/8/2018</span>
                <span>9/8/2018</span>
                <span class="more">details</span>
            <li>
                <span>Optimisation Multi-objectif des Systèmes Embarqués</span>
                <span>Master</span>
                <span>9/8/2018</span>
                <span>9/8/2018</span>
                <span class="more">details</span>
            </li>
        </ul>


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="../javascript/BARSS.js"></script>
        <script src="../javascript/notification.js"></script>
        <script>

            let selectedOptions = {
                    type: null,
                    acronyme: null,
                };
            
                function showType(type) {
                    selectedOptions.type = (selectedOptions.type === type) ? null : type;
                    document.querySelector('.filtre3 .textBox').value = selectedOptions.type ? type : '';
                }
            
            
              const yearInput1 = document.getElementById('yearInput1');
              const yearInput2 = document.getElementById('yearInput2');
              const errorMessage1 = document.getElementById('errorMessage1');
              const errorMessage2 = document.getElementById('errorMessage2');
            
              yearInput1.addEventListener('input', () => {
            
                const year = yearInput1.value.trim();
            
                yearInput1.addEventListener('keydown', (event) => {
              if (event.keyCode === 13) {
                  if (yearInput1.value.length >= 4 && yearInput1.value !== '' && year <= 2024 && year > 1990) {
                      errorMessage1.textContent = ''; 
                  } else {
                      errorMessage1.textContent = 'Erreur : Année invalide .';
                      errorMessage1.style.color = 'red';
                      errorMessage1.style.fontSize = '12px';
                  }
              }
            });
            
                    
                while (isNaN(year) || year > 2024 || year < 1990) {
            
            
                  if (event.keyCode === 13) {
                   if (year.length < 4) {
                    errorMessage1.textContent = 'Erreur : Année invalide.';
                    errorMessage1.style.color = 'red';
                    errorMessage1.style.fontSize = '12px';
                    return;
                  }
            
                  if (year === '' ) {
                    // Effacer le message d'erreur
                    errorMessage1.textContent = '';
                    return;
                  }
                  }
            
                  if (year === '' ) {
                    // Effacer le message d'erreur
                    errorMessage1.textContent = '';
                    return;
                  }
            
            
                  if (isNaN(year)) {
                    // Afficher un message d'erreur
                    errorMessage1.textContent = 'Erreur : Veuillez entrer une année valide.';
                    errorMessage1.style.color = 'red';
                    errorMessage1.style.fontSize = '12px';
                    return;
                  }
            
                  if ((year > 2024 || year < 1990)) {
            
                    if (year.length < 4) {
                    errorMessage1.textContent = '';
                    return;
                  }
                    else {
                    // Afficher un message d'erreur
                    errorMessage1.textContent = 'Erreur : Année invalide .';
                    errorMessage1.style.color = 'red';
                    errorMessage1.style.fontSize = '12px';
                    return;
                  }
                }
                
                }
              
                errorMessage1.textContent = '';
                validateYearOrder(year, yearInput2.value.trim(), errorMessage2);
            });
            
            
            
              //--------------------------------------------------------------------------------------------//
            
              yearInput2.addEventListener('input', () => {
            
                const year = yearInput2.value.trim();
                const startYear = parseInt(yearInput1.value.trim());
                const endYear = parseInt(yearInput2.value.trim());
            
                yearInput2.addEventListener('keydown', (event) => {
              if (event.keyCode === 13) {
                  if (yearInput2.value.length >= 4 && yearInput2.value !== '' && year <= 2024 && year > 1990) {
                      errorMessage2.textContent = ''; 
                  } else {
                      errorMessage2.textContent = 'Erreur : Année invalide.';
                      errorMessage2.style.color = 'red';
                      errorMessage2.style.fontSize = '12px';
                  }
              }
            });
            
                while (isNaN(year) || year > 2024 || year < 1990) {
            
                  if (event.keyCode === 13) {
                   if (year.length < 4) {
                    errorMessage2.textContent = 'Erreur : Année invalide.';
                    errorMessage2.style.color = 'red';
                    errorMessage2.style.fontSize = '12px';
                    return;
                  }
            
                  if (year === '' ) {
                    // Effacer le message d'erreur
                    errorMessage2.textContent = '';
                    return;
                  }
                  }
            
                  if (year === '' ) {
                    // Effacer le message d'erreur
                    errorMessage2.textContent = '';
                    return;
                  }
            
            
                  if (isNaN(year)) {
                    // Afficher un message d'erreur
                    errorMessage2.textContent = 'Erreur : Veuillez entrer une année valide.';
                    errorMessage2.style.color = 'red';
                    errorMessage2.style.fontSize = '12px';
                    return;
                  }
            
                  if ((year > 2024 || year < 1990)) {
            
                    if (year.length < 4) {
                    errorMessage2.textContent = '';
                    return;
                    }
                    else  {
                    // Afficher un message d'erreur
                    errorMessage2.textContent = 'Erreur : Année invalide.';
                    errorMessage2.style.color = 'red';
                    errorMessage2.style.fontSize = '12px';
                    return;
                    }
                    if ((year.length < 4) && event.keyCode === 13) {
                    errorMessage2.textContent = 'Erreur : Année invalide.';
                    errorMessage2.style.color = 'red';
                    errorMessage2.style.fontSize = '12px';
                    return;
                    }
                    }
                }
              
            
                validateYearOrder(yearInput1.value.trim(), year, errorMessage1);
                });
            
                function validateYearOrder(startYear, endYear, errorMessage) {
                  if (parseInt(endYear) < parseInt(startYear)) {
                    errorMessage.textContent = 'Erreur : Année invalide(fin<debut)';
                    errorMessage.style.color = 'red';
                    errorMessage.style.fontSize = '12px';
                  } else {
                    errorMessage.textContent = '';
            }
            }
            
              let dropdowns = document.querySelectorAll('.dropdown');
                  dropdowns.forEach(dropdown => {
                  let menuIcon = dropdown.querySelector('.menu-icon');
                  dropdown.onclick = function() {
                    menuIcon.classList.toggle('active');
                    dropdown.classList.toggle('active');
                };
              });
            
                 document.addEventListener("DOMContentLoaded", function() {
                const form = document.querySelector('.partie-recherche form');
                const resultList = document.querySelector('.publication-list');
            
                form.addEventListener('submit', function(event) {
                    event.preventDefault(); // Empêche le formulaire de se soumettre normalement
            
                    const searchQuery = document.querySelector('.rechercher').value.trim();
            
                    // Envoi de la requête AJAX avec Fetch
                    fetch(`http://127.0.0.1:8000/api/encadrements/genesearch/?q=${searchQuery}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                           // 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzE0MzMxNDE3LCJpYXQiOjE3MTQzMzA4MTcsImp0aSI6ImYyODI3N2M2NDEzNDQ0ZWU4NjRiODFkNTA1MGY5ZTZkIiwidXNlcl9pZCI6MjJ9.1i5FH27KRdX1SgIV6CR1I53qRv2xHvM2vURpy2sDSWs' // Remplacez par votre jeton d'accès
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                              if (data.length === 0) {
                            // No results found, redirect to notFound.html
                            window.location.href = 'file:///C:/Users/ASUS%20TUF%20A15/PycharmProjects/Auth2/front/html/notFound1.html';
                        } else {
                            resultList.innerHTML = '';
            
                        // Boucle à travers les résultats et les affiche sur la page
                        data.forEach(item => {
                            const encadrementHTML = `
                                <li>
                                    <span>${item.intitule}</span>
                                    <span>${item.type_encadrement}</span>
                                    <span>${item.annee_debut}</span>
                                    <span>${item.annee_fin}</span>
                                    <span class="more" onclick="redirectToDetails('${item.detail_url}')">details</span>
                                </li>
                            `;
                            resultList.insertAdjacentHTML('beforeend', encadrementHTML);
                        });
                    }
                    })
                    .catch(error => {
                       console.error('Error fetching data:', error);
                        window.location.href = 'file:///C:/Users/ASUS%20TUF%20A15/PycharmProjects/Auth2/front/html/notFound3.html';
                    });
                });
            });
            
            document.addEventListener("DOMContentLoaded", function() {
                const filterButton = document.querySelector('.button-filtrer');
                const resultList = document.querySelector('.publication-list');
            
                filterButton.addEventListener('click', function(event) {
                    event.preventDefault(); // Empêche le formulaire de se soumettre normalement
            
                    const searchQuery = document.querySelector('.rechercher').value.trim();
                    const typeEncadrement = document.querySelector('.filtre3 .textBox').value.trim();
                    const dateDebut = document.querySelector('#yearInput1').value.trim();
                    const dateFin = document.querySelector('#yearInput2').value.trim();
                    const motCle = document.querySelector('.filtre4 .textBox').value.trim();
            
                    // Envoi de la requête AJAX avec Fetch
                    fetch(`http://127.0.0.1:8000/api/encadrements/search/?q=${searchQuery}&type_encadrement=${typeEncadrement}&date_debut=${dateDebut}&date_fin=${dateFin}&mot_cle=${motCle}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            //'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzE0MzM2OTk2LCJpYXQiOjE3MTQzMzYzOTYsImp0aSI6ImZkMDJkNDYxYTA3ZDRkODVhMWYwZjZkYWRlNjRjMTM1IiwidXNlcl9pZCI6MjJ9.38UvBOIvoCEUORXaRcCj0LB7AKLVaMagEYle2GZL5AM' // Remplacez par votre jeton d'accès
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                              if (data.length === 0) {
                            // No results found, redirect to notFound.html
                            window.location.href = 'file:///C:/Users/ASUS%20TUF%20A15/PycharmProjects/Auth2/front/html/notFound1.html';
                        } else {
                                  resultList.innerHTML = '';
            
                                  // Boucle à travers les résultats et les affiche sur la page
                                  data.forEach(item => {
                                      const encadrementHTML = `
                                <li>
                                    <span>${item.intitule}</span>
                                    <span>${item.type_encadrement}</span>
                                    <span>${item.annee_debut}</span>
                                    <span>${item.annee_fin}</span>
                                    <span class="more" onclick="redirectToDetails('${item.detail_url}')">details</span>
                                </li>
                            `;
                                      resultList.insertAdjacentHTML('beforeend', encadrementHTML);
                                  });
                              }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        window.location.href = 'file:///C:/Users/ASUS%20TUF%20A15/PycharmProjects/Auth2/front/html/notFound3.html';
                    });
                });
            });
            document.addEventListener("DOMContentLoaded", function() {
                fetch('http://127.0.0.1:8000/api/encadrements/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const resultList = document.querySelector('.publication-list');
            
                    // Effacer le contenu existant de la liste
                    resultList.innerHTML = '';
            
                    // Boucle à travers les résultats et les affiche sur la page
                    data.forEach(item => {
                        const encadrementHTML = `
                            <li>
                                <span>${item.intitule}</span>
                                <span>${item.type_encadrement}</span>
                                <span>${item.annee_debut}</span>
                                <span>${item.annee_fin}</span>
                                <span class="more" onclick="redirectToDetails('${item.detail_url}')">details</span>
                            </li>
                        `;
                        resultList.insertAdjacentHTML('beforeend', encadrementHTML);
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
            });
            
            
            function redirectToDetails(detailUrl) {
                // Extraire l'ID de la publication depuis l'URL
                const encadrementId = detailUrl.match(/\/(\d+)\/$/)[1];
            
                // Stocker l'ID de la publication, le nom et le prénom du chercheur, ainsi que le rang du chercheur dans la session
                sessionStorage.setItem('id_encadrement', encadrementId);
            
            
                // Redirection vers la page voirpublication.html
                window.location.href = '../html/voirencadrement.html';
            }
            
            </script>
</body>
</html>