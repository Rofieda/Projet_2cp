<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width , initial-scale=1.0">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="../styles/BARS.css">
    <link rel="stylesheet" href="../styles/ajout.css">

    <script src="../javascript/BARS.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap">
    <title>Lmcs Quest</title>
</head>

<body>

    <div class="pub">
        <div class="pub-title">
            <img src="../images/news violet.png">
            <p> données bibliographiques - Conférence/Revue</p>
        </div>
        <div class="pub-content">
            <div class="pub-container" id="originalInfo">
                <div class="left-pub-info2">
                    <p>Titre de conférence-journal :</p>
                    <p>Type :</p>
                    <p>Périodicité:</p>
                    <p>Acronyme :</p>
                    <p>maison d'edition :</p>
                    <p>lien de site Conférence-Journal :</p>
                    <p>Core Classification :</p>
                    <p>Scimago Classification :</p>
                    <p>Qualis Classification :</p>
                    <p>Dgrsdt Classification :</p>
                </div>
                <div class="input-select">
                    <input type="text" id="titre" name="titre">
                    <select id="rang1" name="rang1">
                        <option value="" disabled selected></option>
                        <option value="Conférence">Conférence</option>
                        <option value="Journal">Journal</option>
                    </select>
                    <select id="rang2" name="rang2">
                        <option value="" disabled selected></option>
                        <option value="Ad hoc">Ad hoc</option>
                        <option value="Continuelle">Continuelle</option>
                        <option value="Saisonniére">Saisonniére</option>
                        <option value="Mensuelle">Mensuelle</option>
                        <option value="Bimensuelle">Bimensuelle</option>
                        <option value="Trimestrielle">Trimestrielle</option>
                        <option value="Semestrielle">Semestrielle</option>
                        <option value="Annuelle">Annuelle</option>
                        <option value="Biennale">Biennale</option>
                        <option value="Triennale">Triennale</option>
                        <option value="Quadriennale">Quadriennale</option>
                        <option value="Quinquemestrielle">Quinquemestrielle</option>
                        <option value="Hebdomadaire">Hebdomadaire</option>
                        <option value="Biquadrimestrielle">Biquadrimestrielle</option>
                        <option value="Spéciale/Supplémentaire">Spéciale/Supplémentaire</option>
                        <option value="autre">autre</option>
                    </select>
                    <input type="text" id="acronyme" name="acronyme">
                    <input type="text" id="lien" name="lien">
                    <input type="text" id="maison_edition" name="maison_edition">
                    <select id="core" name="core">
                        <option value="" disabled selected></option>
                        <option value="A*">A*</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                    <select id="scimago" name="scimago">
                        <option value="" disabled selected></option>
                        <option value="Q1">Q1</option>
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                    </select>
                    <select id="qualis" name="qualis">
                        <option value="" disabled selected></option>
                        <option value="A1">A1</option>
                        <option value="A2">A2</option>
                        <option value="B1">B1</option>
                        <option value="B2">B2</option>
                        <option value="B3">B3</option>
                        <option value="B4">B4</option>
                        <option value="B5">B5</option>
                        <option value="C">C</option>
                    </select>
                    <select id="dgrsdt" name="dgrsdt">
                        <option value="" disabled selected></option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
            </div>
            <button class="Ajouter-button" onclick="AddConf()"><img src="../images/Tick white.png">Ajouter</button>
        </div>
    </div>

    <div id="popup" class="popup">
        <p><img src="../images/appliquer.png">Le Conférence-Journal a été <br>ajouté avec succès !</p>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 

    <script src="../javascript/BARSS.js"></script>
    <script src="../javascript/notification.js"></script>
    <script src="../javascript/ajout.js"></script>

    <script>

$(document).ready(function() {
    // Add event listeners to input fields
    $('#titre,#rang1, #rang2, #acronyme, #lien, #core, #scimago, #qualis, #dgrsdt, #maison_edition').on('input', handleInputChange);
});


function handleInputChange() {
    var titre = $("#titre").val();
            var type = $("#rang1").val() === "1" ? "Conférence" : "Journal"; // Translate value to text
            var periodicite = $("#rang2").val();
            var acronyme = $("#acronyme").val();
            var lien = $("#lien").val();
            var core_classification = $("#core").val();
            var scimago_classification = $("#scimago").val();
            var qualis_classification = $("#qualis").val();
            var dgrsdt_classification = $("#dgrsdt").val();
            var maison_edition = $("#maison_edition").val();

        var isValid = titre &&  periodicite && acronyme &&  lien && core_classification && scimago_classification && qualis_classification && dgrsdt_classification && maison_edition ;

        // Get the button element
        var button = $('.Ajouter-button');

        // If isValid is false, disable the button and change its style
        if (!isValid) {
        button.prop('disabled', true);
        button.css({
                    'background-color': '#cccccc',
                    'cursor': 'not-allowed'
                });
        
    } else {
        button.prop('disabled', false);
                button.css({
                    'background-color': '',
                    'cursor': 'pointer'
                });
    }
}





        function AddConf() {
            var titre = $("#titre").val();
            var type = $("#rang1").val() === "1" ? "Conférence" : "Journal"; // Translate value to text
            var periodicite = $("#rang2").val();
            var acronyme = $("#acronyme").val();
            var lien = $("#lien").val();
            var core_classification = $("#core").val();
            var scimago_classification = $("#scimago").val();
            var qualis_classification = $("#qualis").val();
            var dgrsdt_classification = $("#dgrsdt").val();
            var maison_edition = $("#maison_edition").val();


            var data = {
                "nom": titre,
                "p_type": type,
                "maison_edition": maison_edition,
                "periodicite": periodicite,
                "acronyme": acronyme,
                "lien": lien,
                "core_classification": core_classification,
                "scimago_classification": scimago_classification,
                "qualis_classification": qualis_classification,
                "dgrsdt_classification":dgrsdt_classification
            };

            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:8000/api/ConfJournalCreat/",
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzE0OTI0MjEwLCJpYXQiOjE3MTQ5MjM2MTAsImp0aSI6IjMyNWU0ZjI1ZTBjNDRhNmE4ODgxNThmNzZkODg3ZWIyIiwidXNlcl9pZCI6Mn0.tUIKV3YTfGigpCv5CFAkxqaMiOAKcmeo8x2GgTCxyBs' // Include authentication token if needed
                },
                data: JSON.stringify(data),
                success: function (response) {
                    applyChange('Le conf revue a été ajouté avec succès !');
                    
                },
                error: function (xhr, status, error) {
                    console.error('Erreur lors de l\'ajout');
                    console.error(xhr.responseText);
                }
            });
        }
        //TOKEN INTEGRATION /



        

           async function getAccessToken() {
             await refreshAccessToken();
             return sessionStorage.getItem('access_token');
          }

     async function refreshAccessToken() {
    // Retrieve refresh token from session storage
    const refresh_token = JSON.parse(sessionStorage.getItem('user_info')).refresh_token;
    if (refresh_token) {
        try {
            const response = await fetch('http://127.0.0.1:8000/api/v1/auth/token/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refresh: refresh_token })
            });
            const data = await response.json();
            // Update the access token in session storage
            const userInfo = JSON.parse(sessionStorage.getItem('user_info'));
            sessionStorage.setItem('access_token', data.access);
            sessionStorage.setItem('user_info', JSON.stringify(userInfo)); // Store all updated user information
            // Retry the original request or perform other actions
        } catch (error) {
            // Handle token refresh error
            console.error(error);
            // Redirect the user to the login page or display an error message
        }
    } else {
        // Redirect the user to the login page if there is no refresh token
    }
}



async function AddConf() {
    var titre = $("#titre").val();
    var type = $("#rang1").val() === "1" ? "Conférence" : "Journal"; // Translate value to text
    var periodicite = $("#rang2").val();
    var acronyme = $("#acronyme").val();
    var lien = $("#lien").val();
    var core_classification = $("#core").val();
    var scimago_classification = $("#scimago").val();
    var qualis_classification = $("#qualis").val();
    var dgrsdt_classification = $("#dgrsdt").val();
    var maison_edition = $("#maison_edition").val();




    var isValid = titre && periodicite && acronyme && lien && core_classification && scimago_classification && qualis_classification && dgrsdt_classification && maison_edition;

// Get the button element
var button = $('.Ajouter-button');

// If isValid is false, disable the button and change its style
if (!isValid) {
    button.prop('disabled', true);
    button.css({
        'background-color': '#cccccc',
        'cursor': 'not-allowed'
    });
} else {
    button.prop('disabled', false);
    button.css({
        'background-color': '',
        'cursor': 'pointer'
    });
}






    var data = {
        "nom": titre,
        "p_type": type,
        "maison_edition": maison_edition,
        "periodicite": periodicite,
        "acronyme": acronyme,
        "lien": lien,
        "core_classification": core_classification,
        "scimago_classification": scimago_classification,
        "qualis_classification": qualis_classification,
        "dgrsdt_classification": dgrsdt_classification
    };

    try {
        // Get the access token
        const accessToken = await getAccessToken();

        // Make the fetch request with the access token
        const response = await fetch('http://127.0.0.1:8000/api/ConfJournalCreat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify(data)
        });

        // Handle the response as needed
        if (response.ok) {
            const responseData = await response.json();
            showPopup();
            
            // Handle success response
        } else {
            // Handle error response
            console.error('Error:', response.statusText);
        }
    } catch (error) {
        // Handle any errors that occur during the request
        console.error('Error:', error);
    }
}

    </script>
</body>

</html>
